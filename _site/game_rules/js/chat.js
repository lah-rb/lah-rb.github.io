const KipukasChat=(()=>{const J="https://kippa.kipukas.us/graphql",T="wss://kippa.kipukas.us/graphql";let t=null,m=!1,k=!1,L=0,y=0;const q=5;let i=!1,E,h,S,N,c,C,l,u,o;function x(e){if(!e)return"";const n=marked.parse(e,{breaks:!0});return DOMPurify.sanitize(n)}function p(e,n=!1,d=!1){const r=document.createElement("div");r.className=`flex ${n?"justify-end":"justify-start"}`;const a=document.createElement("div");a.className=`chat-bubble rounded-xl px-3 py-2 ${n?"bg-sky-600 text-white rounded-br-sm":"bg-sky-800 text-sky-100 rounded-bl-sm"}${d?" streaming-cursor":""}`;const s=document.createElement("div");return s.className="markdown-content",n?s.textContent=e:s.innerHTML=x(e),a.appendChild(s),r.appendChild(a),c.appendChild(r),c.scrollTop=c.scrollHeight,s}function P(e,n){e.innerHTML=x(n),c.scrollTop=c.scrollHeight}function O(e){l.disabled=!e,u.disabled=!e,e?l.placeholder="Ask Kippa...":l.placeholder="Connecting..."}function v(){t?.readyState===WebSocket.OPEN||t?.readyState===WebSocket.CONNECTING||(t=new WebSocket(T,"graphql-transport-ws"),t.onopen=()=>{t.send(JSON.stringify({type:"connection_init"}))},t.onmessage=e=>{const n=JSON.parse(e.data);n.type==="connection_ack"?(m=!0,y=0,o.className="w-2 h-2 rounded-full bg-green-500",o.title="Connected",O(!0),c.children.length===0&&p("Hi! I'm Kippa. Ask me anything about the Kipukas rules.")):n.type==="connection_error"&&(m=!1,o.className="w-2 h-2 rounded-full bg-red-500",o.title="Disconnected")},t.onerror=()=>{m=!1,o.className="w-2 h-2 rounded-full bg-red-500",o.title="Error"},t.onclose=()=>{if(m=!1,o.className="w-2 h-2 rounded-full bg-gray-500",o.title="Disconnected",O(!1),y<q){y++;const e=Math.min(1e3*Math.pow(2,y-1),3e4);setTimeout(v,e)}})}function H(e){return new Promise((n,d)=>{if(!m||t?.readyState!==WebSocket.OPEN){d(new Error("WebSocket not connected"));return}const r=(++L).toString();let a="",s=null,g=null,I=!1;const f=t.onmessage;t.onmessage=B=>{const b=JSON.parse(B.data);if(b.id===r)switch(b.type){case"next":const w=b.payload?.data?.streamCompletion;w&&(a+=w.text,s?P(s,a):(s=p(a,!1,!0),g=s.parentElement),w.isComplete&&(I=!0,g&&g.classList.remove("streaming-cursor"),t.send(JSON.stringify({id:r,type:"complete"})),t.onmessage=f,n({text:a})));break;case"error":t.onmessage=f,d(new Error(b.payload?.message||"Subscription error"));break}else f(B)},t.send(JSON.stringify({id:r,type:"subscribe",payload:{query:`subscription { streamCompletion(request: { prompt: ${JSON.stringify(e)} }) { text isComplete } }`}})),setTimeout(()=>{I||(t.onmessage=f,t.send(JSON.stringify({id:r,type:"complete"})),g&&g.classList.remove("streaming-cursor"),n({text:a}))},12e4)})}async function M(e){return(await(await fetch(J,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`mutation { createCompletion(request: { prompt: ${JSON.stringify(e)} }) { text tokensGenerated } }`})})).json()).data?.createCompletion}async function W(e){e.preventDefault();const n=l.value.trim();if(!(!n||k)){p(n,!0),l.value="",l.focus(),k=!0,u.disabled=!0,u.textContent="...";try{try{await H(n)}catch{const d=await M(n);d?.text&&p(d.text,!1)}}catch{p("Sorry, something went wrong. Please try again.",!1)}finally{k=!1,u.disabled=!1,u.textContent="Send"}}}function $(){i=!i,h.classList.toggle("hidden",!i),i?h.style.display="flex":h.style.display="",S.classList.toggle("hidden",i),N.classList.toggle("hidden",!i),i&&!t&&v()}function j(){E=document.getElementById("chat-toggle"),h=document.getElementById("chat-panel"),S=document.getElementById("chat-icon-open"),N=document.getElementById("chat-icon-close"),c=document.getElementById("chat-messages"),C=document.getElementById("chat-form"),l=document.getElementById("chat-input"),u=document.getElementById("chat-send"),o=document.getElementById("chat-status"),E.addEventListener("click",$),C.addEventListener("submit",W),window.addEventListener("beforeunload",()=>{t&&t.close()})}return{init:j}})();
