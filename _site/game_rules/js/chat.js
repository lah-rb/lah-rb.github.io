const KipukasChat=(()=>{const v="https://kippa.kipukas.us/graphql",B="wss://kippa.kipukas.us/graphql";let t=null,m=!1,k=!1,M=0,g=0;const P=5;let l=!1,w,y,E,C,c,N,d,u,a;function O(e){if(!e)return"";const n=marked.parse(e,{breaks:!0});return DOMPurify.sanitize(n)}function p(e,n=!1,i=!1){const r=document.createElement("div");r.className=`flex ${n?"justify-end":"justify-start"}`;const o=document.createElement("div");o.className=`chat-bubble rounded-xl px-3 py-2 ${n?"bg-sky-600 text-white rounded-br-sm":"bg-sky-800 text-sky-100 rounded-bl-sm"}${i?" streaming-cursor":""}`;const s=document.createElement("div");return s.className="markdown-content",n?s.textContent=e:s.innerHTML=O(e),o.appendChild(s),r.appendChild(o),c.appendChild(r),c.scrollTop=c.scrollHeight,s}function H(e,n){e.innerHTML=O(n),c.scrollTop=c.scrollHeight}function T(e){d.disabled=!e,u.disabled=!e,e?d.placeholder="Ask Kippa...":d.placeholder="Connecting..."}function x(){t?.readyState===WebSocket.OPEN||t?.readyState===WebSocket.CONNECTING||(t=new WebSocket(B,"graphql-transport-ws"),t.onopen=()=>{t.send(JSON.stringify({type:"connection_init"}))},t.onmessage=e=>{const n=JSON.parse(e.data);n.type==="connection_ack"?(m=!0,g=0,a.className="w-2 h-2 rounded-full bg-green-500",a.title="Connected",T(!0),c.children.length===0&&p("Hi! I'm Kippa. Ask me anything about the Kipukas rules.")):n.type==="connection_error"&&(m=!1,a.className="w-2 h-2 rounded-full bg-red-500",a.title="Disconnected")},t.onerror=()=>{m=!1,a.className="w-2 h-2 rounded-full bg-red-500",a.title="Error"},t.onclose=()=>{if(m=!1,a.className="w-2 h-2 rounded-full bg-gray-500",a.title="Disconnected",T(!1),g<P){g++;const e=Math.min(1e3*Math.pow(2,g-1),3e4);setTimeout(x,e)}})}function J(e){return new Promise((n,i)=>{if(!m||t?.readyState!==WebSocket.OPEN){i(new Error("WebSocket not connected"));return}const r=(++M).toString();let o="",s=null,f=null,I=!1;const h=t.onmessage;t.onmessage=L=>{const b=JSON.parse(L.data);if(b.id===r)switch(b.type){case"next":const S=b.payload?.data?.streamCompletion;S&&(o+=S.text,s?H(s,o):(s=p(o,!1,!0),f=s.parentElement),S.isComplete&&(I=!0,f&&f.classList.remove("streaming-cursor"),t.send(JSON.stringify({id:r,type:"complete"})),t.onmessage=h,n({text:o})));break;case"error":t.onmessage=h,i(new Error(b.payload?.message||"Subscription error"));break}else h(L)},t.send(JSON.stringify({id:r,type:"subscribe",payload:{query:`subscription { streamCompletion(request: { prompt: ${JSON.stringify(e)} }) { text isComplete } }`}})),setTimeout(()=>{I||(t.onmessage=h,t.send(JSON.stringify({id:r,type:"complete"})),f&&f.classList.remove("streaming-cursor"),n({text:o}))},12e4)})}async function _(e){return(await(await fetch(v,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`mutation { createCompletion(request: { prompt: ${JSON.stringify(e)} }) { text tokensGenerated } }`})})).json()).data?.createCompletion}async function W(e){e.preventDefault();const n=d.value.trim();if(!(!n||k)){p(n,!0),d.value="",d.focus(),k=!0,u.disabled=!0,u.textContent="...";try{try{await J(n)}catch{const i=await _(n);i?.text&&p(i.text,!1)}}catch{p("Sorry, something went wrong. Please try again.",!1)}finally{k=!1,u.disabled=!1,u.textContent="Send"}}}function q(){l=!l,y.classList.toggle("hidden",!l),l?y.style.display="flex":y.style.display="",E.classList.toggle("hidden",l),C.classList.toggle("hidden",!l),l&&!t&&x()}function A(){w=document.getElementById("chat-toggle"),y=document.getElementById("chat-panel"),E=document.getElementById("chat-icon-open"),C=document.getElementById("chat-icon-close"),c=document.getElementById("chat-messages"),N=document.getElementById("chat-form"),d=document.getElementById("chat-input"),u=document.getElementById("chat-send"),a=document.getElementById("chat-status"),w.addEventListener("click",q),N.addEventListener("submit",W),window.addEventListener("beforeunload",()=>{t&&t.close()})}return{init:A}})();
