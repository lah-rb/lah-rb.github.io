importScripts("/assets/js/workbox/workbox-v7.3.0/workbox-sw.js"),workbox.setConfig({modulePathPrefix:"/assets/js/workbox/workbox-v7.3.0/"});const{setCacheNameDetails,clientsClaim}=workbox.core,{precacheAndRoute,cleanupOutdatedCaches}=workbox.precaching,{registerRoute}=workbox.routing,{NetworkFirst,StaleWhileRevalidate,CacheFirst}=workbox.strategies,{ExpirationPlugin}=workbox.expiration;setCacheNameDetails({prefix:"kipukas-pwa"});let pwaInstalled=!1;self.addEventListener("message",t=>{t.data&&t.data.type==="SKIP_WAITING"&&self.skipWaiting(),t.data&&t.data.type==="PWA_INSTALLED"&&(pwaInstalled=!0),t.data&&t.data.type==="PWA_INSTALL_CHECK"&&t.ports&&t.ports[0]&&t.ports[0].postMessage({installed:pwaInstalled})}),clientsClaim(),precacheAndRoute(self.__WB_MANIFEST,{ignoreURLParametersMatching:[/^utm_/,/^fbclid$/]}),cleanupOutdatedCaches();const wasmApiMatcher=({url:t})=>t.pathname.startsWith("/api/"),wasmApiHandler=async({request:t,event:s})=>{const e=await self.clients.get(s.clientId);if(!e)return new Response('<span class="text-kip-red">No controlling page found for WASM relay</span>',{status:503,headers:{"Content-Type":"text/html; charset=utf-8"}});const a=new URL(t.url),o=["POST","PUT","PATCH"].includes(t.method)?await t.text():"";return new Promise((c,r)=>{const n=new MessageChannel,l=setTimeout(()=>{r(new Response('<span class="text-kip-red">WASM request timed out</span>',{status:504,headers:{"Content-Type":"text/html; charset=utf-8"}}))},5e3);n.port1.onmessage=i=>{clearTimeout(l),c(new Response(i.data.html,{status:i.data.ok?200:500,headers:{"Content-Type":"text/html; charset=utf-8"}}))},e.postMessage({type:"WASM_REQUEST",method:t.method,pathname:a.pathname,search:a.search,body:o},[n.port2])})};registerRoute(wasmApiMatcher,wasmApiHandler),registerRoute(wasmApiMatcher,wasmApiHandler,"POST"),registerRoute(wasmApiMatcher,wasmApiHandler,"PUT"),registerRoute(wasmApiMatcher,wasmApiHandler,"PATCH"),registerRoute(/\.(?:html)$/,new NetworkFirst({cacheName:"kipukas-pages",networkTimeoutSeconds:3,matchOptions:{ignoreSearch:!0},plugins:[{cacheWillUpdate:async({response:t})=>t&&t.status===200?t:null}]})),registerRoute(/\.(?:css|js|wasm)$/,new StaleWhileRevalidate({cacheName:"kipukas-assets",plugins:[{cacheWillUpdate:async({response:t})=>t&&t.status===200?t:null},new ExpirationPlugin({maxEntries:200,maxAgeSeconds:720*60*60,purgeOnQuotaError:!0})]})),registerRoute(/\.(?:png|jpg|jpeg|svg|gif|webp|ico)$/,new CacheFirst({cacheName:"kipukas-images",plugins:[{cacheWillUpdate:async({response:t})=>t&&t.status===200?t:null},new ExpirationPlugin({maxEntries:500,maxAgeSeconds:1440*60*60,purgeOnQuotaError:!0})]})),registerRoute(/^https:\/\/fonts\.(?:googleapis|gstatic)\.com\/.*/i,new CacheFirst({cacheName:"kipukas-fonts",plugins:[new ExpirationPlugin({maxEntries:30,maxAgeSeconds:365*24*60*60})]})),self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(s=>Promise.all(s.filter(e=>{const a=e.startsWith("kipukas-")&&/kipukas-(?:pages|assets|images|fonts)-[a-f0-9]{64}/.test(e),o=e.startsWith("my-app-cache-");return a||o}).map(e=>(console.log("[SW] Deleting old cache:",e),caches.delete(e))))))});
