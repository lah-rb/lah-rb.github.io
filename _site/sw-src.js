importScripts("/assets/js/workbox/workbox-v7.3.0/workbox-sw.js"),workbox.setConfig({modulePathPrefix:"/assets/js/workbox/workbox-v7.3.0/"});const{setCacheNameDetails,clientsClaim}=workbox.core,{precacheAndRoute,cleanupOutdatedCaches}=workbox.precaching,{registerRoute}=workbox.routing,{NetworkFirst,StaleWhileRevalidate,CacheFirst}=workbox.strategies,{ExpirationPlugin}=workbox.expiration;setCacheNameDetails({prefix:"kipukas-pwa"}),self.addEventListener("message",e=>{e.data&&e.data.type==="SKIP_WAITING"&&self.skipWaiting()}),clientsClaim(),precacheAndRoute(self.__WB_MANIFEST,{ignoreURLParametersMatching:[/^utm_/,/^fbclid$/]}),cleanupOutdatedCaches();const wasmApiMatcher=({url:e})=>e.pathname.startsWith("/api/"),wasmApiHandler=async({request:e,event:a})=>{const t=await self.clients.get(a.clientId);if(!t)return new Response('<span class="text-kip-red">No controlling page found for WASM relay</span>',{status:503,headers:{"Content-Type":"text/html; charset=utf-8"}});const s=new URL(e.url),n=["POST","PUT","PATCH"].includes(e.method)?await e.text():"";return new Promise((c,r)=>{const o=new MessageChannel,l=setTimeout(()=>{r(new Response('<span class="text-kip-red">WASM request timed out</span>',{status:504,headers:{"Content-Type":"text/html; charset=utf-8"}}))},5e3);o.port1.onmessage=i=>{clearTimeout(l),c(new Response(i.data.html,{status:i.data.ok?200:500,headers:{"Content-Type":"text/html; charset=utf-8"}}))},t.postMessage({type:"WASM_REQUEST",method:e.method,pathname:s.pathname,search:s.search,body:n},[o.port2])})};registerRoute(wasmApiMatcher,wasmApiHandler),registerRoute(wasmApiMatcher,wasmApiHandler,"POST"),registerRoute(wasmApiMatcher,wasmApiHandler,"PUT"),registerRoute(wasmApiMatcher,wasmApiHandler,"PATCH"),registerRoute(/\.(?:html)$/,new NetworkFirst({cacheName:"kipukas-pages",networkTimeoutSeconds:3,matchOptions:{ignoreSearch:!0},plugins:[{cacheWillUpdate:async({response:e})=>e&&e.status===200?e:null}]})),registerRoute(/\.(?:css|js|wasm)$/,new StaleWhileRevalidate({cacheName:"kipukas-assets",plugins:[{cacheWillUpdate:async({response:e})=>e&&e.status===200?e:null},new ExpirationPlugin({maxEntries:200,maxAgeSeconds:720*60*60,purgeOnQuotaError:!0})]})),registerRoute(/\.(?:png|jpg|jpeg|svg|gif|webp|ico)$/,new CacheFirst({cacheName:"kipukas-images",plugins:[{cacheWillUpdate:async({response:e})=>e&&e.status===200?e:null},new ExpirationPlugin({maxEntries:500,maxAgeSeconds:1440*60*60,purgeOnQuotaError:!0})]})),registerRoute(/^https:\/\/fonts\.(?:googleapis|gstatic)\.com\/.*/i,new CacheFirst({cacheName:"kipukas-fonts",plugins:[new ExpirationPlugin({maxEntries:30,maxAgeSeconds:365*24*60*60})]})),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(a=>Promise.all(a.filter(t=>{const s=t.startsWith("kipukas-")&&/kipukas-(?:pages|assets|images|fonts)-[a-f0-9]{64}/.test(t),n=t.startsWith("my-app-cache-");return s||n}).map(t=>(console.log("[SW] Deleting old cache:",t),caches.delete(t))))))});
