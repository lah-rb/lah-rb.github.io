<canvas id="canvas" class="z-40 fixed -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"
  width="640" height="480">
</canvas>
<video id="video"
  class="z-30 fixed w-80 -translate-x-1/2 -translate-y-1/2 scale-x-[-1] top-1/2 left-1/2 rounded-lg transition delay-150"
  x-show="showScanner && !noCamera && videoReady">
</video>

<script>
  // Access alpine.js x-data
  let alpinel = document.querySelector('[x-data]');
  let QRFound = false;

  // Access the video and canvas elements
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext("2d", { willReadFrequently: true }, { alpha: false });
  const dpr = window.devicePixelRatio;
  canvas.width = 320 * dpr; // Double the width and height for HD-resolution
  canvas.height = 240 * dpr;
  context.scale(dpr, dpr); // scale the context appropriately
  const spinner = document.getElementById('spinner');

  // Establish zxing from zxing_reader.js
  var zxing = ZXing().then(function (instance) {
    zxing = instance; // this line is supposedly not required but with current emsdk it is :-/
  });


  // Function to start scanning for QR codes
  function startScanning() {
    let consent = alpinel._x_dataStack[0].acceptPrivacy;
    if (consent) {
      // Get access to the camera
      navigator.mediaDevices
        .getUserMedia({ video: {
          facingMode: 'user',
          width: {
            ideal: 1920,
            min: 320
          },
          height: {
            ideal: 1080,
            min: 240
          },
          frameRate: {
            ideal: 60,
            min: 10
          }},
          audio: false
        })
        .then(function(stream) {
          video.srcObject = stream;
          video.setAttribute('playsinline', true); // required to tell iOS safari we don't want fullscreen
          video.play();
          requestAnimationFrame(scanForQR);
          setTimeout(() => {
            alpinel._x_dataStack[0].videoReady = true;
          }, 200);

        })
        .catch(function(err) {
          console.error('Camera access error:', err);
        });
    }
  }

  function stopScanning() {
    cancelAnimationFrame(requestAnimationFrame);
    if (video.srcObject) {
      video.srcObject.getTracks()[0].stop();
      video.srcObject = null;
      alpinel._x_dataStack[0].videoReady = false;
    }
  }

  function readBarcodeFromCanvas(canvas, format, mode) {
    var imgWidth = canvas.width;
    var imgHeight = canvas.height;
    var imageData = context.getImageData(0, 0, imgWidth, imgHeight);
    var sourceBuffer = imageData.data;

    if (zxing != null) {
      var buffer = zxing._malloc(sourceBuffer.byteLength);
      zxing.HEAPU8.set(sourceBuffer, buffer);
      var result = zxing.readBarcodeFromPixmap(buffer, imgWidth, imgHeight, mode, format);
      zxing._free(buffer);
      return result;
    } else {
      return { error: "ZXing not yet initialized" };
    }
  }

  // Function to scan for QR codes
  function scanForQR() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const resultString = readBarcodeFromCanvas(canvas, "QRCode", false).text;
      if (resultString) {
        console.log(resultString)
        const url = resultString;
        // Check if the URL starts with "http://" or "https://"
        if (url.startsWith('http://') || url.startsWith('https://')) {
          stopScanning();
          QRFound = true;
          window.location.href = url.replace('http://', 'https://www.kpks.us/');
        } else {
          console.log('Invalid URL detected in QR code');
        }
      }
    }
    if(!QRFound) {
      requestAnimationFrame(scanForQR);
    }
  }
</script>
