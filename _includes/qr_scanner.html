<canvas id="canvas" class="-z-10 fixed -translate-x-1/2 -translate-y-1/2 scale-x-[-1] top-1/2 left-1/2" style="display:none;"></canvas>
<img id="orbTemp" src="/assets/utility_images/qr_template.png" style="display:none;" />
<video id="video"
  class="z-30 fixed w-80 -translate-x-1/2 -translate-y-1/2 scale-x-[-1] top-1/2 left-1/2 rounded-lg transition delay-150"
  x-show="showScanner && !noCamera && videoReady" style="display:none;">
</video>
<!--<canvas id="debugCanvas" ></canvas>-->

<script>
  // Access the video and canvas elements
  let alpinel = document.querySelector('[x-data]');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const orbTemp = document.getElementById('orbTemp');
  const context = canvas.getContext('2d');
  const debugCanvas = document.createElement('canvas');
  const spinner = document.getElementById('spinner');
  debugCanvas.width = 256;
  debugCanvas.height = 128;
  const debugContext = debugCanvas.getContext('2d');
  var zxing = ZXing().then(function (instance) {
    zxing = instance; // this line is supposedly not required but with current emsdk it is :-/
  });


  // Function to start scanning for QR codes
  function startScanning() {
    let consent = alpinel._x_dataStack[0].acceptPrivacy;
    if (consent) {
      // Get access to the camera
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: 'user' }, audio: false })
        .then(function(stream) {
          video.srcObject = stream;
          video.setAttribute('playsinline', true); // required to tell iOS safari we don't want fullscreen
          video.play();
          requestAnimationFrame(scanForQR);
          setTimeout(() => {
            alpinel._x_dataStack[0].videoReady = true;
          }, 300);

        })
        .catch(function(err) {
          console.error('Camera access error:', err);
        });
    }
  }

  function stopScanning() {
    cancelAnimationFrame(requestAnimationFrame);
    if (video.srcObject) {
      video.srcObject.getTracks()[0].stop();
      video.srcObject = null;
      alpinel._x_dataStack[0].videoReady = false;
    }
  }

  function preProcess() {

          context.drawImage(video, 0, 0, 300, 150);
          const imageData = context.getImageData(0, 0, 300, 150);
          let qr_template = cv.imread('orbTemp')

          let src = cv.imread('canvas');
          //cv.imshow('debugCanvas', src)
          let grayMat = new cv.Mat(imageData.height, imageData.width, cv.CV_8UC1);
          cv.cvtColor(src, grayMat, cv.COLOR_RGBA2GRAY, 0);
          src.delete();

          // Perform morphological operations
          let kernel = cv.Mat.ones(2, 2, cv.CV_8U);
          let erodedMat = new cv.Mat();
          cv.erode(grayMat, erodedMat, kernel);
          grayMat.delete();

          let dilatedMat = new cv.Mat();
          cv.dilate(erodedMat, dilatedMat, kernel);
          erodedMat.delete();
          kernel.delete();

          // Apply adaptive threshold
          let thresholdMat = new cv.Mat();
          cv.adaptiveThreshold(dilatedMat, thresholdMat, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY, 11, 5);
          dilatedMat.delete();

          cv.imshow('canvas', thresholdMat);
          thresholdMat.delete();
          const resultImg = context.getImageData(0, 0, 300, 150)

          return imageData;
  }

  function readBarcodeFromCanvas(canvas, format, mode) {
    var imgWidth = canvas.width;
    var imgHeight = canvas.height;
    var imageData = canvas.getContext('2d').getImageData(0, 0, imgWidth, imgHeight);
    var sourceBuffer = imageData.data;

    if (zxing != null) {
      var buffer = zxing._malloc(sourceBuffer.byteLength);
      zxing.HEAPU8.set(sourceBuffer, buffer);
      var result = zxing.readBarcodeFromPixmap(buffer, imgWidth, imgHeight, mode, format);
      zxing._free(buffer);
      return result;
    } else {
      return { error: "ZXing not yet initialized" };
    }
  }

  // Function to scan for QR codes
  function scanForQR() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const preProcessedImage = preProcess();
      const resultString = readBarcodeFromCanvas(canvas, "QRCode" , true).text;
      if (resultString) {
        console.log(resultString)
        const url = resultString;
        // Check if the URL starts with "http://" or "https://"
        if (url.startsWith('http://') || url.startsWith('https://')) {
          // Navigate to the URL on your local server (assuming your local server's address is "http://127.0.0.1:4000/")
          window.location.href = url.replace('http://', 'https://www.kpks.us/'); //'http://127.0.0.1:4000/');
          stopScanning();
        } else {
          console.log('Invalid URL detected in QR code');
        }
      }
    }
    requestAnimationFrame(scanForQR);
  }
</script>
