<div class="z-50 fixed w-full md:w-auto top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 mt-1 max-h-96">
  <video id="video" class="w-full h-auto max-h-96 scale-y-[-1]" x-show="showScanner" x-transition style="display:none;"></video>
  <canvas id="canvas" class="w-full h-auto max-h-96" style="display:none;"></canvas>

  <script>
    // Access the video and canvas elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    // Function to start scanning for QR codes
    function startScanning(showModal) {
      if (showModal) {
        // Get access to the camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
          .then(function(stream) {
            video.srcObject = stream;
            video.setAttribute('playsinline', true); // required to tell iOS safari we don't want fullscreen
            video.play();
            requestAnimationFrame(scan);
          })
          .catch(function(err) {
            console.error('Camera access error:', err);
          });
      }
    }
    // Get the image data
    let imageData = context.getImageData(0, 0, canvas.width, canvas.height);

    // Apply adaptive thresholding for noise reduction
    for (let i = 0; i < imageData.data.length; i += 4) {
        let red = imageData.data[i];
        let green = imageData.data[i + 1];
        let blue = imageData.data[i + 2];

        let averageColor = Math.round((red + green + blue) / 3);
        let adaptiveThreshold = Math.max(Math.max(red, green), blue) - Math.min(Math.min(red, green), blue);

        // Apply adaptive thresholding filter
        imageData.data[i] = averageColor + adaptiveThreshold;
        imageData.data[i + 1] = averageColor + adaptiveThreshold;
        imageData.data[i + 2] = averageColor + adaptiveThreshold;
    }

    // Adjust contrast
    for (let i = 0; i < imageData.data.length; i += 4) {
        let red = imageData.data[i];
        let green = imageData.data[i + 1];
        let blue = imageData.data[i + 2];

        // Apply a contrast enhancement filter
        imageData.data[i] = red * 1.5; // Increase the contrast
        imageData.data[i + 1] = green * 1.5;
        imageData.data[i + 2] = blue * 1.5;
    }

    // Put the image data back to the canvas
    context.putImageData(imageData, 0, 0);
    // Function to scan for QR codes
    function scan() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        context.drawImage(video, 0, 0, 300, 200);
        const imageData = context.getImageData(0, 0, 300, 200);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth", // or "tryInvertedFirst"
        });

        if (code) {
          console.log('QR code detected:', code.data);
          if (code) {
            // Assuming your QR codes contain URLs starting with "http://" or "https://"
            const url = code.data;

            // Check if the URL starts with "http://" or "https://"
            if (url.startsWith('http://') || url.startsWith('https://')) {
              // Navigate to the URL on your local server (assuming your local server's address is "http://127.0.0.1:4000/")
              window.location.href = url.replace('http://', 'http://www.kpks.us/'); //'http://127.0.0.1:4000/');
            } else {
              console.log('Invalid URL detected in QR code');
            }
          }
        }
      }
      requestAnimationFrame(scan);
    }
  </script>
</div>
