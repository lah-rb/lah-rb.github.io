<canvas id="canvas" class="-z-10 fixed -translate-x-1/2 -translate-y-1/2 scale-x-[-1] top-1/2 left-1/2" style="display:none;"></canvas>
<video id="video"
  class="z-30 fixed w-80 -translate-x-1/2 -translate-y-1/2 scale-x-[-1] top-1/2 left-1/2 rounded-lg transition delay-150"
  x-show="showScanner && !noCamera && videoReady" style="display:none;">
</video>
<!--<canvas id="debugCanvas" ></canvas>-->

<script>
  // Access the video and canvas elements
  let alpinel = document.querySelector('[x-data]');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const debugCanvas = document.createElement('canvas');
  const spinner = document.getElementById('spinner');
  debugCanvas.width = 256;
  debugCanvas.height = 128;
  const debugContext = debugCanvas.getContext('2d');


  // Function to start scanning for QR codes
  function startScanning() {
    let consent = alpinel._x_dataStack[0].acceptPrivacy;
    if (consent) {
      // Get access to the camera
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
        .then(function(stream) {
          video.srcObject = stream;
          video.setAttribute('playsinline', true); // required to tell iOS safari we don't want fullscreen
          video.play();
          requestAnimationFrame(scanForQR);
          setTimeout(() => {
            alpinel._x_dataStack[0].videoReady = true;
          }, 300);

        })
        .catch(function(err) {
          console.error('Camera access error:', err);
        });
    }
  }

  function stopScanning() {
    cancelAnimationFrame(requestAnimationFrame);
    if (video.srcObject) {
      video.srcObject.getTracks()[0].stop();
      video.srcObject = null;
      alpinel._x_dataStack[0].videoReady = false;
    }
  }

  function preProcess() {
     try {
          context.drawImage(video, 0, 0, 300, 150);
          const imageData = context.getImageData(0, 0, 300, 150);

          let src = cv.imread('canvas');
          //cv.imshow('debugCanvas', src)
          let grayMat = new cv.Mat(imageData.height, imageData.width, cv.CV_8UC1);
          cv.cvtColor(src, grayMat, cv.COLOR_RGBA2GRAY, 0);
          src.delete();

          let equalized = new cv.Mat();
          cv.equalizeHist(grayMat, equalized);

          // Perform morphological operations
          let kernel = cv.Mat.ones(2, 2, cv.CV_8U);
          let erodedMat = new cv.Mat();
          cv.erode(equalized, erodedMat, kernel);
          grayMat.delete();

          let dilatedMat = new cv.Mat();
          cv.dilate(erodedMat, dilatedMat, kernel);
          erodedMat.delete();
          kernel.delete();

          // Apply adaptive threshold
          let thresholdMat = new cv.Mat();
          cv.adaptiveThreshold(dilatedMat, thresholdMat, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY, 11, 5);
          dilatedMat.delete();

          cv.imshow('canvas', thresholdMat);
          thresholdMat.delete();
          const resultImg = context.getImageData(0, 0, 300, 150)

          return resultImg;
     }
     catch (err) {
         console.log('An error occurred:', err);
         startScanning(true)
     }
  }

  // Function to scan for QR codes
  async function scanForQR() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      const preProcessedImage = preProcess();
      const scanner = await zbarWasm.getDefaultScanner();
      scanner.setConfig(
      	zbarWasm.ZBarSymbolType.ZBAR_NONE, /* "None" for "All", design by original ZBar library */
      	zbarWasm.ZBarConfigType.ZBAR_CFG_ENABLE, /* The field you want to change */
      	0 /* 0 for disable */
      );
      scanner.setConfig(zbarWasm.ZBarSymbolType.ZBAR_QRCODE, zbarWasm.ZBarConfigType.ZBAR_CFG_ENABLE, 1);
      scanner.enableCache(true);
      const symbols = await zbarWasm.scanImageData(preProcessedImage, scanner);
      symbols.forEach(s => s.rawValue = s.decode('utf-8'));
      symbols.forEach(symbol => {
        code = symbol.rawValue;
        if (code) {
          console.log('QR code detected:', code);
          if (code) {
            const url = code;
            // Check if the URL starts with "http://" or "https://"
            if (url.startsWith('http://') || url.startsWith('https://')) {
              // Navigate to the URL on your local server (assuming your local server's address is "http://127.0.0.1:4000/")
              window.location.href = url.replace('http://', 'https://www.kpks.us/'); //'http://127.0.0.1:4000/');
              stopScanning();
            } else {
              console.log('Invalid URL detected in QR code');
            }
          }
        }
      });
    }
    requestAnimationFrame(scanForQR);
  }
</script>
