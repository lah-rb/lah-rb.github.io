<!-- Phase B: Affinity tracking tool (Pattern 11).
     Declare archetypal affinity once per day. Active affinity grants +1 roll
     bonus on matching cards during fists combat. State stored in PLAYER_DOC. -->
<div x-data="{ showAffinity: false }"
     class="relative place-content-center">

    <!-- Trigger button — DNA helix icon representing archetypal adaptation -->
    <button @click="showAffinity = !showAffinity" class="flex justify-center" aria-label="Archetypal Affinity">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
            class="{{ include.svgClass }} {{ include.base_stroke }}">
            <!-- DNA double helix icon -->
            <path d="M2 15c6.667-6 13.333 0 20-6" />
            <path d="M9 3.236s1.87 1 3.5 2.764M14.5 18A19.1 19.1 0 0 1 8 22" />
            <path d="M8.5 6A19.1 19.1 0 0 1 15 2" />
            <path d="M14.5 18s-1.87-1-3.5-2.764" />
            <path d="M2 9c6.667 6 13.333 0 20 6" />
            <path d="M6 12h12" />
        </svg>
    </button>

    <!-- Modal overlay -->
    <div x-show="showAffinity" x-cloak
        class="fixed inset-0 flex items-center justify-center z-50"
        x-transition.duration.350ms
        x-effect="if (showAffinity) $nextTick(() => {
            if (typeof htmx !== 'undefined') {
                var today = new Date().toISOString().slice(0,10);
                htmx.ajax('GET', '/api/player/affinity?today=' + today,
                    {target:'#affinity-container', swap:'innerHTML'});
            }
        })">

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-300 opacity-75" @click="showAffinity = false"></div>

        <!-- Modal content -->
        <div class="bg-amber-50 z-50 rounded-lg shadow-xl w-full max-w-sm max-h-[85vh] overflow-y-auto relative">

            <!-- HTMX container — WASM renders the affinity panel -->
            <div id="affinity-container"
              hx-get="/api/player/affinity"
              hx-trigger="load"
              hx-swap="innerHTML">
            </div>

            <!-- Close button -->
            <button @click="showAffinity = false"
              class="w-full bg-slate-400 hover:bg-slate-500 text-amber-50 font-bold py-2 px-4 rounded-b text-sm">
              Close
            </button>
        </div>
    </div>
</div>

<!-- Supply today's date to the initial hx-get on page load -->
<script>
(function() {
  var el = document.getElementById('affinity-container');
  if (el) {
    var today = new Date().toISOString().slice(0,10);
    el.setAttribute('hx-get', '/api/player/affinity?today=' + today);
  }
})();
</script>
