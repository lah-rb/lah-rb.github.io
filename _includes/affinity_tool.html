<!-- Phase B: Affinity tracking tool (Pattern 11).
     Declare archetypal affinity once per day. Active affinity grants +1 roll
     bonus on matching cards during fists combat. State stored in PLAYER_DOC. -->
<div x-data="{ showAffinity: false }"
     class="relative place-content-center">

    <!-- Trigger button — heart icon representing archetypal affinity -->
    <button @click="showAffinity = !showAffinity" class="flex justify-center" aria-label="Archetypal Affinity">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
            {% unless page.landscape %}
              :class="'lg:fill-kip-goldenrod'"
            {% endunless %}
            class="{{ include.svgClass }} {{ include.base_stroke }}">
            <path d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
        </svg>
    </button>

    <!-- Modal overlay -->
    <div x-show="showAffinity" x-cloak
        class="fixed inset-0 flex items-center justify-center z-50"
        x-transition.duration.350ms
        x-effect="if (showAffinity) $nextTick(() => {
            if (typeof htmx !== 'undefined') {
                var today = new Date().toISOString().slice(0,10);
                htmx.ajax('GET', '/api/player/affinity?today=' + today,
                    {target:'#affinity-container', swap:'innerHTML'});
            }
        })">

        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-300 opacity-75" @click="showAffinity = false"></div>

        <!-- Modal content -->
        <div class="bg-amber-50 z-50 rounded-lg shadow-xl w-full max-w-sm max-h-[85vh] overflow-y-auto relative">

            <!-- HTMX container — WASM renders the affinity panel -->
            <div id="affinity-container"
              hx-get="/api/player/affinity"
              hx-trigger="load"
              hx-swap="innerHTML">
            </div>

            <!-- Close button -->
            <button @click="showAffinity = false"
              class="w-full bg-slate-400 hover:bg-slate-500 text-amber-50 font-bold py-2 px-4 rounded-b text-sm">
              Close
            </button>
        </div>
    </div>
</div>

<!-- Supply today's date to the initial hx-get on page load -->
<script>
(function() {
  var el = document.getElementById('affinity-container');
  if (el) {
    var today = new Date().toISOString().slice(0,10);
    el.setAttribute('hx-get', '/api/player/affinity?today=' + today);
  }
})();
</script>
