// Load Workbox from local vendored copy (generated by: deno task setup:workbox)
importScripts('/assets/js/workbox/workbox-v7.3.0/workbox-sw.js');

// Tell workbox-sw to load all modules from local path instead of CDN
workbox.setConfig({ modulePathPrefix: '/assets/js/workbox/workbox-v7.3.0/' });

const { setCacheNameDetails, clientsClaim } = workbox.core;
const { precacheAndRoute, cleanupOutdatedCaches } = workbox.precaching;
const { registerRoute } = workbox.routing;
const { NetworkFirst, StaleWhileRevalidate, CacheFirst } = workbox.strategies;
const { ExpirationPlugin } = workbox.expiration;

// ============================================
// CACHE NAMING
// ============================================
// Static cache names — no version hash so runtime caches persist across deploys.
// Precaching already handles versioning via file-revision hashes.
setCacheNameDetails({ prefix: 'kipukas-pwa' });

// ============================================
// LIFECYCLE: controlled skipWaiting via postMessage
// ============================================
// Do NOT call self.skipWaiting() automatically.
// The client (pwa-update-handler.js) will send a SKIP_WAITING message
// when the user chooses to update, giving them control over the timing.
self.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'SKIP_WAITING') {
    self.skipWaiting();
  }
});

clientsClaim();

// ============================================
// PRECACHING
// ============================================
// The placeholder below is replaced at build time by workbox-cli
// injectManifest with the list of revisioned URLs.
precacheAndRoute([{"revision":"27553d8ec9fc25229bad32d175cf11e4","url":"404.html"},{"revision":"7151335eafb00d4c184bc4ffad643bda","url":"about_articles.html"},{"revision":"b738880413e428de2ea99bfc77c3a1f4","url":"about_the_binder.html"},{"revision":"24abd229a89d3db2034db1b487d4263c","url":"allele_sect_explorer/index.html"},{"revision":"297ac2df56d8a09c902c40fc52b2d8ac","url":"AnxM.html"},{"revision":"09f59cad42b11ad645de08c12ae65aab","url":"arctechnic_wonderer/index.html"},{"revision":"e65ed55fadadbb3fc2b9c2c783a0e11c","url":"artificer_of_the_salt_chancel/index.html"},{"revision":"13f88c15f64c474b11acda2550312020","url":"aS1Q.html"},{"revision":"c1c89c1d062ecc10d68899532dcfb640","url":"avian_keepers_den/index.html"},{"revision":"98aa3602027d3057edad3f1794fe9a54","url":"balanced_inline_processing_colony/index.html"},{"revision":"de5e2b6846aa5e5188c4bc68026cb00b","url":"BB5S.html"},{"revision":"05b742cc109cf7b93d95282edc3c701d","url":"branwen_mantillusion_practitioner/index.html"},{"revision":"21774a64e5e26a2aeb1cf9462ad577b2","url":"brOL.html"},{"revision":"1b53ae702e8174e7fd6cc8c9abce5f29","url":"brox_the_defiant/index.html"},{"revision":"5e8db99b302526485b9c263d9829f466","url":"bSGc.html"},{"revision":"8a740fcf2e7bceca93fb541dbbce1d43","url":"cartesian_sea/index.html"},{"revision":"e147dc7df9977373421c2d72359e814d","url":"cloth/index.html"},{"revision":"bfab2a77d8b2b071f534899dc090b497","url":"dVxr.html"},{"revision":"a877f8517c025b925791bc42536bb968","url":"dxc9.html"},{"revision":"9d7825bb06953d81156c1c0b63f6ee87","url":"enchantress_of_cats/index.html"},{"revision":"ca2dd5546a4c540adbe460a7043138da","url":"Eppu.html"},{"revision":"7c5a0f4215a17e7228c20f8bae3f823e","url":"eUN0.html"},{"revision":"909c19929b2f95761751997d211724e7","url":"F3GW.html"},{"revision":"2e7fd4288a562c6a596fec89078a36f8","url":"feathers/index.html"},{"revision":"fa745bb02d0bc6b167fa89d6fabac6c1","url":"feeding_the_piffions/index.html"},{"revision":"e46ae2bf31077fda6cd9b3449dbbd1bb","url":"fFvj.html"},{"revision":"be3c604cc91775250c3afaa891941d75","url":"FOFE.html"},{"revision":"9b741bfed112d92e91aaa2fb1aa0c9b3","url":"fourohfour.html"},{"revision":"9fb235a4405a08ea8b7a2e0db5e60dbf","url":"freezing_of_the_heart/index.html"},{"revision":"b1f3add76fed1b4d20088b79d9504fb5","url":"frlU.html"},{"revision":"0e26f1b27068ead1896ae63ec75b4b0a","url":"frost_tipped_arctic_otter/index.html"},{"revision":"d67492add1bf53cc23e03ace68c82eb4","url":"FuOw.html"},{"revision":"df8b0060145f3e2bc57b0148f7e9f430","url":"G8OO.html"},{"revision":"9d7a2f47148f1ae6d7e62cd204c90da8","url":"game_rules/index.html"},{"revision":"2f32ae7ceed98734ebd2963c75d721a2","url":"gray_wolf_harbinger_of_night/index.html"},{"revision":"e8bc9088b8bc6907dea5b23681594508","url":"H8wj.html"},{"revision":"824a91db574c210d2842b395885a75f9","url":"Hh2Y.html"},{"revision":"c30973559d7c4811a9f9b2d780e52d2a","url":"hidden_portal_of_lower_dreadmont_cave/index.html"},{"revision":"0a4c225f53f13a08e89a5800a507ca9f","url":"hilbert_king_of_avian_frogs/index.html"},{"revision":"6d28332e4e77c6c929df538b093c2e7c","url":"hLwQ.html"},{"revision":"568351934a19f5b23bb88577686c2f86","url":"HMPU.html"},{"revision":"d759aa4dce07c1a83c06b57ee606c78f","url":"honey/index.html"},{"revision":"2671dd59c558a4e95d7e5c749ddfe47f","url":"I19b.html"},{"revision":"7d61b38cfd149d0205fc93f61786346f","url":"illia_and_dorsay_the_buck_skull/index.html"},{"revision":"710acba14df4c9f3ac2c167ea2e1c1df","url":"incubation_egg/index.html"},{"revision":"a724ad7c1adb56e19ae72d9aea0f73c3","url":"index.html"},{"revision":"e96ab002651097108ad1de300501b0db","url":"ioqs.html"},{"revision":"38bee1b6387e4611ac9ee45504f8b0f6","url":"IR2B.html"},{"revision":"aedd6ed1b369928e76002dd86fa8bc9b","url":"J2Ls.html"},{"revision":"b07ab05151018f82fbc8c818c9183af8","url":"J7a0.html"},{"revision":"541fec7d267d43030efef92e273fa0cc","url":"jKPw.html"},{"revision":"0c814cb2fe7889eaafdaf792595dd82c","url":"jSYU.html"},{"revision":"52afc27403a44fad170d61c18851b0c1","url":"K_vJ.html"},{"revision":"f8bbfef986e023c59460f6c7ccd59bbb","url":"K-LE.html"},{"revision":"73143dd6fa549ac60704c9c46f570b8e","url":"k8on.html"},{"revision":"5af3c79b106cbe61efe08570568fd708","url":"KCW4.html"},{"revision":"1675a1893f446df5e70873dfdd9a13ad","url":"KE4V.html"},{"revision":"3b8fc336bf84fd886d532b2790fa51fd","url":"knightsoul_of_binding_time/index.html"},{"revision":"7659f12fb180c1133d340ba08ffab5fa","url":"KVph.html"},{"revision":"635f37371ccdb065f9c5ee5f66561df3","url":"L-E7.html"},{"revision":"bde06406467040d17276a5ff844da0bf","url":"Lbap.html"},{"revision":"9d43f70a12c976f2ce3105126b7141c4","url":"liliel_healing_fairy/index.html"},{"revision":"b6b584aed88dd23e72b5c5c5f34a57e4","url":"little_charm/index.html"},{"revision":"dea7ef4da8b3c2d6b71054a89fe546b7","url":"location_of_the_deep_apothecary_shop/index.html"},{"revision":"9562f0140dfb4aae6c846e1cfc6ef5b1","url":"losetany_steppes/index.html"},{"revision":"91e8405695a7703fa2f4846507a7aa5f","url":"mechanics_development.html"},{"revision":"832796e6a27d9538112b71cce023d9ea","url":"meteor_shower/index.html"},{"revision":"805c3890105d1929da1bd3f78aa730b0","url":"mGCe.html"},{"revision":"c7a06c301856291fe7b06e781c3e36f4","url":"mihela_cleanser_of_fields/index.html"},{"revision":"72cf30b3c7d596e92fe49b4dc8aeb21c","url":"mutant_hide_and_seek/index.html"},{"revision":"3b81f7ce629455b69b573fbcb32f610e","url":"myrthvither_raven/index.html"},{"revision":"465e6375513eea30ae428612f99af976","url":"neural_network_synapse_virus/index.html"},{"revision":"45fef29ad76033ff50e95f3a17d57175","url":"nqTG.html"},{"revision":"30901b86bcd167033d90fc1c0a9bdc7a","url":"offline.html"},{"revision":"f42214a37bdcecd4781ce3e1acfb47a4","url":"ojod.html"},{"revision":"cf5ab67351f632d617b657c464d20e14","url":"onironauta/index.html"},{"revision":"4b59bace4dbaa0d6d8f72bfef594b6d7","url":"oOnN.html"},{"revision":"fb59342e4c1722501d4a8e046037e806","url":"orbs_trail/index.html"},{"revision":"c5a3960cc2d8b808a647d8ebda18a07c","url":"oshliath_and_osileth/index.html"},{"revision":"d7c13f07c5368735bf255de6d091544c","url":"P2IR.html"},{"revision":"7cad6c9b49e987f43009d69a0bc13c41","url":"palace_of_the_allele_sect/index.html"},{"revision":"b47a4f5e875cbd671612214b424d0875","url":"parched_traveler/index.html"},{"revision":"0ee268c54a841731d0c3c383a414e9b0","url":"passage_among_maples/index.html"},{"revision":"5305a18562306d42fafa23f17e8f3d65","url":"PhAU.html"},{"revision":"fcda01400debb91860c3cd5ea004060f","url":"plane_table_joker/index.html"},{"revision":"297d5769e4f30fec1a5bb30355dca2e1","url":"privacy_policy.html"},{"revision":"805611341ecb044647fae17bafbdf01a","url":"pVLu.html"},{"revision":"66dadaa05e96a10c843c1b2f05442a8a","url":"pyrostegia_dragon/index.html"},{"revision":"887a132e161f7bc3c79d61b91cd76355","url":"r4GS.html"},{"revision":"4f46ee40c89f6f3921cede838c06e9fd","url":"recipes.html"},{"revision":"fc53effc56110e32d0fa54a2b242be31","url":"ro1A.html"},{"revision":"16cd9bbfaecf7b4dfebca96f16488480","url":"rooster_calling_of_light/index.html"},{"revision":"264714b72afe530f57504aa8e90dbde2","url":"RrDC.html"},{"revision":"04a4191d9bc1de4324806e1ab428ccc2","url":"sboi_threat_plus_plus/index.html"},{"revision":"942799bcbe475a82be18c5855d429ea1","url":"self_care/index.html"},{"revision":"cc2deedd6e45768edbb1910c5d79af91","url":"shards_desert/index.html"},{"revision":"aa7d9131cca98a7ea0139962a4ae507d","url":"SmCK.html"},{"revision":"ba89f1e5727e3dbbfea7418a2c20bc4c","url":"spectral_lands_decree_and_hearing/index.html"},{"revision":"1b6bb6ac71dc615b399541d9a0cab515","url":"sprite_of_wilds_spirit/index.html"},{"revision":"bea9aa08145e77944f093a583346a000","url":"sticks/index.html"},{"revision":"667ff33f0187d69b22b072d0142ba965","url":"string/index.html"},{"revision":"770afaa4073b3ffb4fd976af0ef6e8fa","url":"suspended_animation/index.html"},{"revision":"64dbd57e8440d8a8710211a3e7481209","url":"SWyA.html"},{"revision":"6af02f5278fd2f24bbd0ebd15a1d3d38","url":"tears_for_oly/index.html"},{"revision":"e80a43b4637823bc31c1ccbb230d9a17","url":"tejas_curious_mech/index.html"},{"revision":"897f4f70ec59b034eb573554c88747fa","url":"the_causal_sophist/index.html"},{"revision":"2aea8f1dd8ecc9983d8a8de0a654e5ae","url":"timebattle/index.html"},{"revision":"d155658b7950c402041ba3c6dc473605","url":"tira_marvelous_myriad/index.html"},{"revision":"38d1a0b31d636d86e7201f6c6ea3c629","url":"TlVv.html"},{"revision":"48bf7e3a4a173561b67f8c33db2476b0","url":"to_catch_a_spirit/index.html"},{"revision":"248c4fc32f17ba4b83637794ab311a69","url":"unburdened_central/index.html"},{"revision":"b50b22b1f38dad185a2106e4b4a068a9","url":"ushered_through_sabina_emporium/index.html"},{"revision":"bab3cd8dbe1b3942377330fc399d47d3","url":"v5Bi.html"},{"revision":"92a5605d0b1a44c89038631b13dcb0c4","url":"WCA9.html"},{"revision":"af96794ca900253c3b345972bfe674f3","url":"what_do_you_see_in_the_breach/index.html"},{"revision":"d54fe19aba1a7a1857b26b3eb012634c","url":"WWpl.html"},{"revision":"8bfa603edc380c3b019bac665f3dec0a","url":"y5ZD.html"},{"revision":"fbb32bf37ce8336cbe55e76151a2f759","url":"yDLL.html"},{"revision":"5425a374fed558e2d985a4efeeffa6cd","url":"YRkt.html"},{"revision":"80ca86da6c5082f82bfeb12cb18122ad","url":"zIGm.html"},{"revision":"7ea469df9bbdd9d0e7ab0fcf89060077","url":"ZrrD.html"},{"revision":"ce1239f7f02ac613a9df1bc8f3579937","url":"zVBp.html"},{"revision":"9bebfb5bf3adc9d50fa4cd93b3e651da","url":"zwZA.html"},{"revision":"d1813ad525b9e2bb30da1fad2feaf228","url":"assets/css/input.css"},{"revision":"d67595a8c676320146f01977585865ef","url":"assets/css/output.css"},{"revision":"b44842818b126b7dce50bb9f8c08efa5","url":"assets/js/alpine.bundle.min.js"},{"revision":"19a573773be4ca22570ca2f8543120c5","url":"assets/js/htmx.min.js"},{"revision":"dddedbe7510a1063f82fe085d3fbdd88","url":"assets/js/kipukas-api.js"},{"revision":"7aac32af44e25f24845602bfde36c055","url":"assets/js/kipukas-multiplayer.js"},{"revision":"12f4c10ad9ce17b54f9d78da2b3b6118","url":"assets/js/kipukas-worker.js"},{"revision":"737948b56cc603e0730f300086ba9169","url":"assets/js/pwa-update-handler.js"},{"revision":"dc599ab5d1f097b2121d29bcc7876f4a","url":"assets/js/qr-camera.js"},{"revision":"fdea78e10dc15a4990329b2bc73f4418","url":"assets/js/workbox/workbox-v7.3.0/workbox-background-sync.dev.js"},{"revision":"7df2b4af75f09fd8b18431c69477b127","url":"assets/js/workbox/workbox-v7.3.0/workbox-background-sync.prod.js"},{"revision":"8ebfef1474c401abc98ac889913a8fc9","url":"assets/js/workbox/workbox-v7.3.0/workbox-broadcast-update.dev.js"},{"revision":"c1d6cc1a26b73a488811f841756c1e3c","url":"assets/js/workbox/workbox-v7.3.0/workbox-broadcast-update.prod.js"},{"revision":"98fd7c87ad917a757a80fcb13a0447f7","url":"assets/js/workbox/workbox-v7.3.0/workbox-cacheable-response.dev.js"},{"revision":"a39fe4b9bb1ce7004ff866cc099d4a66","url":"assets/js/workbox/workbox-v7.3.0/workbox-cacheable-response.prod.js"},{"revision":"f4cf052402578b2bdc3862223ee15cd4","url":"assets/js/workbox/workbox-v7.3.0/workbox-core.dev.js"},{"revision":"0f005de088aa3880813a40d4f3a6e2ca","url":"assets/js/workbox/workbox-v7.3.0/workbox-core.prod.js"},{"revision":"0fbf1e2552d85b4ef27d405f08695a33","url":"assets/js/workbox/workbox-v7.3.0/workbox-expiration.dev.js"},{"revision":"855cdca5da43a57ceebc5bc71453053f","url":"assets/js/workbox/workbox-v7.3.0/workbox-expiration.prod.js"},{"revision":"9b8d62a5b332dfd1ca149ae544d86943","url":"assets/js/workbox/workbox-v7.3.0/workbox-navigation-preload.dev.js"},{"revision":"a8b7d0af987ec66a222fd77dd9edde8a","url":"assets/js/workbox/workbox-v7.3.0/workbox-navigation-preload.prod.js"},{"revision":"e0582d1549ee33859a7a539194380aff","url":"assets/js/workbox/workbox-v7.3.0/workbox-offline-ga.dev.js"},{"revision":"193bda9357eb6424434895a7aff8be0e","url":"assets/js/workbox/workbox-v7.3.0/workbox-offline-ga.prod.js"},{"revision":"d38878e5da541af031e060f94cbd7ef5","url":"assets/js/workbox/workbox-v7.3.0/workbox-precaching.dev.js"},{"revision":"311b92de0b058ae6b2564d4cfcb6d0e7","url":"assets/js/workbox/workbox-v7.3.0/workbox-precaching.prod.js"},{"revision":"aaafb1bb11c1b6d8e476d881f3e57652","url":"assets/js/workbox/workbox-v7.3.0/workbox-range-requests.dev.js"},{"revision":"15b201b6b595a97bb0be3d7577b25e9f","url":"assets/js/workbox/workbox-v7.3.0/workbox-range-requests.prod.js"},{"revision":"72ac803e8ae404c639cf8c1526fc14d1","url":"assets/js/workbox/workbox-v7.3.0/workbox-recipes.dev.js"},{"revision":"fab10eeef1a8c9755d5bb38883d4c23d","url":"assets/js/workbox/workbox-v7.3.0/workbox-recipes.prod.js"},{"revision":"018d149d3a27546c153457908042d72c","url":"assets/js/workbox/workbox-v7.3.0/workbox-routing.dev.js"},{"revision":"bc309ea484e6d6e07e8f9216d677f3fe","url":"assets/js/workbox/workbox-v7.3.0/workbox-routing.prod.js"},{"revision":"6b51ad7cf0e44b533b8c617ca0109c63","url":"assets/js/workbox/workbox-v7.3.0/workbox-strategies.dev.js"},{"revision":"41b3f1fa8839eaad412eb38825850272","url":"assets/js/workbox/workbox-v7.3.0/workbox-strategies.prod.js"},{"revision":"da5b52186bde92126440bea1d1f6e459","url":"assets/js/workbox/workbox-v7.3.0/workbox-streams.dev.js"},{"revision":"9259cf1a135007d6a0893b8cde11bfd3","url":"assets/js/workbox/workbox-v7.3.0/workbox-streams.prod.js"},{"revision":"c2eba1515364b627c4f3d5eb6a4bee5b","url":"assets/js/workbox/workbox-v7.3.0/workbox-sw.js"},{"revision":"c9050b3f542e9b1335e5bb4de56a35f2","url":"assets/js/workbox/workbox-v7.3.0/workbox-window.dev.umd.js"},{"revision":"7526eac808d6b2d82b533795861a7220","url":"assets/js/workbox/workbox-v7.3.0/workbox-window.prod.umd.js"},{"revision":"745f80bacc319f9df97deb180b1d0d0a","url":"assets/js-wasm/demoScript.js"},{"revision":"b5b3f18f37f44f0af376a98705e4a400","url":"assets/js-wasm/ios-pwa-splash.js"},{"revision":"320b82f421dff3f6903791cf61da2740","url":"assets/js-wasm/kipukas-server-pkg/kipukas_server_bg.wasm"},{"revision":"b721a1c3f362147238ee4512438c2d6b","url":"assets/js-wasm/kipukas-server-pkg/kipukas_server.js"},{"revision":"9b27e47c1ea72f7a6a6fd22abb4178df","url":"assets/js-wasm/recipes.js"},{"revision":"67ab2ea97e5404ff47013e864eeb88e4","url":"assets/js-wasm/zxing_reader.js"},{"revision":"68f3b2033113a44e690a44fae77e38dd","url":"assets/js-wasm/zxing_reader.wasm"},{"revision":"81244b7d8e44d258bdb51c523e66cc21","url":"assets/utility_images/back.svg"},{"revision":"4e9fbe48dd4e25504a4aec28a15fee90","url":"assets/utility_images/eye-slash.svg"},{"revision":"e99c389867eb52e237032cf14fb2f21a","url":"assets/utility_images/eye.svg"},{"revision":"b7054f06e4bda79679f16772d09552dc","url":"assets/utility_images/fists.svg"},{"revision":"600b150b048396d6014f84d8e36e2658","url":"assets/utility_images/funnel.svg"},{"revision":"a649860a7e42af82c2973d703774ef5c","url":"assets/utility_images/kipukas_complete_card_collection.svg"},{"revision":"5d440b44534fbadf2a0079ac1f2e75cd","url":"assets/utility_images/qr_ico_ink.svg"},{"revision":"0ee5a79d6731c7d253d80f4a9d9bae69","url":"assets/utility_images/search.svg"},{"revision":"d2361bc323c64bc2d49e79ac9498a093","url":"assets/utility_images/topography.svg"},{"revision":"a9a5fdca8b890c0e4eebd370b3192dd4","url":"assets/ico/android-chrome-192x192.png"},{"revision":"04555205ab9d4683bbd6960503cea339","url":"assets/ico/android-chrome-384x384.png"},{"revision":"0dab28f91434ba19e4b13b6e436699c2","url":"assets/ico/apple-touch-icon.png"},{"revision":"6d86bf2dc0448b4107d6f81e30714a58","url":"assets/ico/favicon-16x16.png"},{"revision":"6e268fdc29bd357e42e32dd88c3d8ec1","url":"assets/ico/favicon-32x32.png"},{"revision":"617360864fd77b81f58be6bcaf2e96b7","url":"assets/ico/maskable_icon.png"},{"revision":"9ac295e432f0ff40f5f476f839863e8e","url":"assets/ico/mstile-150x150.png"},{"revision":"9c85ec65e585ef1507da8c4445ee2e79","url":"assets/ico/favicon.ico"},{"revision":"aeef0901c9b8465993c435a81770659c","url":"assets/ico/safari-pinned-tab.svg"},{"revision":"60d5c55b291785509632fad0a4ef75de","url":"manifest.json"},{"revision":"958c5a3e07b88bf3b8158a9baffb450f","url":"site.webmanifest"}], {
  ignoreURLParametersMatching: [/^utm_/, /^fbclid$/],
});
cleanupOutdatedCaches();

// ============================================
// WASM API ROUTES — relay /api/* to page → Web Worker → WASM
// ============================================
// HTMX makes real fetch() calls to /api/* endpoints.
// This route intercepts them and relays to the page's kipukas-api.js bridge,
// which forwards to the WASM Web Worker for processing.
// A MessageChannel provides a direct response path from the worker back to here.
const wasmApiMatcher = ({url}) => url.pathname.startsWith('/api/');
const wasmApiHandler = async ({request, event}) => {
    const client = await self.clients.get(event.clientId);
    if (!client) {
      return new Response(
        '<span class="text-kip-red">No controlling page found for WASM relay</span>',
        { status: 503, headers: { 'Content-Type': 'text/html; charset=utf-8' } }
      );
    }

    const url = new URL(request.url);

    // Read request body for POST/PUT/PATCH methods (Phase 2: needed for future POST routes)
    const body = ['POST', 'PUT', 'PATCH'].includes(request.method)
      ? await request.text()
      : '';

    return new Promise((resolve, reject) => {
      const channel = new MessageChannel();

      // Timeout: if the worker doesn't respond in 5s, fail gracefully
      const timeout = setTimeout(() => {
        reject(new Response(
          '<span class="text-kip-red">WASM request timed out</span>',
          { status: 504, headers: { 'Content-Type': 'text/html; charset=utf-8' } }
        ));
      }, 5000);

      channel.port1.onmessage = (msg) => {
        clearTimeout(timeout);
        resolve(new Response(msg.data.html, {
          status: msg.data.ok ? 200 : 500,
          headers: { 'Content-Type': 'text/html; charset=utf-8' },
        }));
      };

      // Send the request details + one end of the channel to the page.
      // The page's kipukas-api.js will transfer port2 to the WASM Web Worker.
      client.postMessage({
        type: 'WASM_REQUEST',
        method: request.method,
        pathname: url.pathname,
        search: url.search,
        body: body,
      }, [channel.port2]);
    });
  };

// Register for all HTTP methods (Workbox registerRoute defaults to GET only)
registerRoute(wasmApiMatcher, wasmApiHandler);         // GET
registerRoute(wasmApiMatcher, wasmApiHandler, 'POST');  // POST
registerRoute(wasmApiMatcher, wasmApiHandler, 'PUT');   // PUT
registerRoute(wasmApiMatcher, wasmApiHandler, 'PATCH'); // PATCH

// ============================================
// RUNTIME CACHING STRATEGIES
// ============================================

// Strategy 1: HTML Pages — NetworkFirst (fresh content is critical)
registerRoute(
  /\.(?:html)$/,
  new NetworkFirst({
    cacheName: 'kipukas-pages',
    networkTimeoutSeconds: 3,
    matchOptions: { ignoreSearch: true },
    plugins: [
      {
        cacheWillUpdate: async ({ response }) =>
          response && response.status === 200 ? response : null,
      },
    ],
  })
);

// Strategy 2: Static Assets (CSS, JS, WASM) — StaleWhileRevalidate
registerRoute(
  /\.(?:css|js|wasm)$/,
  new StaleWhileRevalidate({
    cacheName: 'kipukas-assets',
    plugins: [
      {
        cacheWillUpdate: async ({ response }) =>
          response && response.status === 200 ? response : null,
      },
      new ExpirationPlugin({
        maxEntries: 200,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
        purgeOnQuotaError: true,
      }),
    ],
  })
);

// Strategy 3: Images — CacheFirst (images rarely change)
registerRoute(
  /\.(?:png|jpg|jpeg|svg|gif|webp|ico)$/,
  new CacheFirst({
    cacheName: 'kipukas-images',
    plugins: [
      {
        cacheWillUpdate: async ({ response }) =>
          response && response.status === 200 ? response : null,
      },
      new ExpirationPlugin({
        maxEntries: 500,
        maxAgeSeconds: 60 * 24 * 60 * 60, // 60 days
        purgeOnQuotaError: true,
      }),
    ],
  })
);

// Strategy 4: Google Fonts — CacheFirst with long expiration
registerRoute(
  /^https:\/\/fonts\.(?:googleapis|gstatic)\.com\/.*/i,
  new CacheFirst({
    cacheName: 'kipukas-fonts',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 30,
        maxAgeSeconds: 365 * 24 * 60 * 60, // 1 year
      }),
    ],
  })
);

// ============================================
// CLEANUP: remove old versioned runtime caches from the previous setup
// ============================================
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) =>
      Promise.all(
        cacheNames
          .filter((name) => {
            // Delete any old runtime caches that contain a version hash
            // (the old format was kipukas-{type}-{hash}_{date})
            const isOldVersionedCache =
              name.startsWith('kipukas-') &&
              /kipukas-(?:pages|assets|images|fonts)-[a-f0-9]{64}/.test(name);
            // Also delete the old "my-app-cache-" prefix from the backup config
            const isLegacyCache = name.startsWith('my-app-cache-');
            return isOldVersionedCache || isLegacyCache;
          })
          .map((name) => {
            console.log('[SW] Deleting old cache:', name);
            return caches.delete(name);
          })
      )
    )
  );
});
